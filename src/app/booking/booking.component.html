<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Card principal -->
      <div class="card shadow-lg mb-4">
        <div class="card-header bg-primary text-white text-center">
          <h2 class="mb-0">
            <i class="bi bi-airplane-fill me-2"></i>
            Confirma tu Reserva
          </h2>
        </div>

        <div class="card-body p-4">
          <!-- Información del vuelo -->
          <div class="flight-summary mb-4" *ngIf="flight()">
            <div class="row">
              <div class="col-md-8">
                <div class="flight-details p-3 bg-light rounded">
                  <h5 class="text-primary mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Detalles del Vuelo
                  </h5>

                  <div class="row g-3">
                    <div class="col-sm-6">
                      <strong>Vuelo:</strong> {{ flight()?.flightNumber }}
                    </div>
                    <div class="col-sm-6">
                      <strong>Ruta:</strong> {{ flight()?.origin }} → {{ flight()?.destination }}
                    </div>
                    <div class="col-sm-6">
                      <strong>Salida:</strong> {{ flight()?.departure | date:'short' }}
                    </div>
                    <div class="col-sm-6">
                      <strong>Aerolínea:</strong> {{ flight()?.airline ? getAirlineName(flight()!.airline) : 'N/A' }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="booking-summary p-3 bg-success bg-opacity-10 rounded border-start border-success border-4">
                  <h5 class="text-success mb-3">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Tu Selección
                  </h5>

                  <div class="mb-2">
                    <strong>Asientos:</strong>
                    <div class="mt-1">
                      @for (seat of seats(); track seat) {
                        <span class="badge bg-primary me-1">{{ seat }}</span>
                      }
                    </div>
                  </div>

                  <div class="mb-2">
                    <strong>Clase:</strong>
                    <span class="badge ms-1"
                          [ngClass]="bookingClass() === 'business' ? 'bg-warning text-dark' : 'bg-info'">
                      {{ bookingClass() === 'business' ? 'Ejecutiva' : 'Económica' }}
                    </span>
                  </div>

                  <div class="mb-2">
                    <strong>Precio unitario:</strong><br>
                    <span class="text-muted">{{ getClassPrice() | currency:'PEN':'symbol':'1.0-0' }}</span>
                  </div>

                  <hr class="my-2">

                  <div class="total-price">
                    <strong class="text-success fs-5">
                      Total: {{ getTotalPrice() | currency:'PEN':'symbol':'1.0-0' }}
                    </strong>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensaje de error si no hay vuelo -->
          <div class="alert alert-warning text-center" *ngIf="!flight()">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Error:</strong> No se encontró información del vuelo.
            <a href="/flights/search" class="alert-link">Busca un vuelo aquí</a>.
          </div>

          <!-- Formulario de reserva -->
          <form [formGroup]="bookingForm" (ngSubmit)="submit()" *ngIf="flight()">

            <!-- Sección de pasajeros -->
            <div class="passengers-section mb-4">
              <h4 class="mb-3">
                <i class="bi bi-people-fill me-2 text-primary"></i>
                Datos de los Pasajeros
              </h4>

              <div formArrayName="passengers">
                <div *ngFor="let p of passengerControls; let i = index"
                     [formGroupName]="i"
                     class="passenger-card mb-3">

                  <div class="card border-primary">
                    <div class="card-header bg-primary bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-person-fill me-2"></i>
                        Pasajero {{ i + 1 }}
                        <span class="badge bg-primary ms-2">Asiento {{ seats()[i] || 'N/A' }}</span>
                      </h6>
                    </div>

                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">
                            <i class="bi bi-person me-1"></i>
                            Nombre Completo *
                          </label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="name"
                            placeholder="Ej: Juan Pérez"
                            [class.is-invalid]="p.get('name')?.invalid && p.get('name')?.touched"
                            required>
                          <div class="invalid-feedback">
                            El nombre es requerido
                          </div>
                        </div>

                        <div class="col-md-3">
                          <label class="form-label">
                            <i class="bi bi-card-text me-1"></i>
                            Documento *
                          </label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="document"
                            placeholder="12345678"
                            [class.is-invalid]="p.get('document')?.invalid && p.get('document')?.touched"
                            required>
                          <div class="invalid-feedback">
                            El documento es requerido
                          </div>
                        </div>

                        <div class="col-md-3">
                          <label class="form-label">
                            <i class="bi bi-calendar me-1"></i>
                            Edad *
                          </label>
                          <input
                            type="number"
                            class="form-control"
                            formControlName="age"
                            min="1"
                            max="120"
                            placeholder="25"
                            [class.is-invalid]="p.get('age')?.invalid && p.get('age')?.touched"
                            required>
                          <div class="invalid-feedback">
                            Edad válida requerida (1-120)
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sección de pago -->
            <div class="payment-section mb-4">
              <h4 class="mb-3">
                <i class="bi bi-credit-card-fill me-2 text-success"></i>
                Método de Pago
              </h4>

              <div class="card border-success">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label for="paymentMethod" class="form-label">
                        <i class="bi bi-wallet2 me-1"></i>
                        Selecciona tu método de pago *
                      </label>
                      <select
                        id="paymentMethod"
                        class="form-select"
                        formControlName="paymentMethod"
                        [class.is-invalid]="bookingForm.get('paymentMethod')?.invalid && bookingForm.get('paymentMethod')?.touched">

                        <option value="" disabled>Selecciona un método</option>

                        @if (paymentMethods().length === 0) {
                          <option disabled>No hay métodos de pago disponibles</option>
                        } @else {
                          @for (method of paymentMethods(); track method.id) {
                            <option [value]="method.id">
                              {{ method.name }}
                            </option>
                          }
                        }
                      </select>
                      <div class="invalid-feedback">
                        Selecciona un método de pago
                      </div>
                    </div>

                    <div class="col-md-6 d-flex align-items-end">
                      <div class="payment-icons">
                        <small class="text-muted d-block mb-2">Métodos aceptados:</small>
                        <i class="bi bi-credit-card fs-4 me-2 text-primary"></i>
                        <i class="bi bi-paypal fs-4 me-2 text-info"></i>
                        <i class="bi bi-bank fs-4 me-2 text-success"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Términos y condiciones -->
            <div class="terms-section mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="acceptTerms" required>
                <label class="form-check-label" for="acceptTerms">
                  Acepto los <a href="#" class="text-primary">términos y condiciones</a>
                  y las <a href="#" class="text-primary">políticas de privacidad</a>
                </label>
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="action-buttons">
              <div class="row g-3">
                <div class="col-md-6">
                  <button
                    type="button"
                    class="btn btn-outline-secondary w-100"
                    (click)="goBack()">
                    <i class="bi bi-arrow-left me-2"></i>
                    Volver a Asientos
                  </button>
                </div>

                <div class="col-md-6">
                  <button
                    type="submit"
                    class="btn btn-success w-100"
                    [disabled]="bookingForm.invalid || loading()">
                    @if (loading()) {
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      Procesando...
                    } @else {
                      <i class="bi bi-check-circle-fill me-2"></i>
                      Confirmar Reserva
                    }
                  </button>
                </div>
              </div>
            </div>

            <!-- Mensaje de éxito -->
            @if (success()) {
              <div class="alert alert-success mt-4 text-center">
                <i class="bi bi-check-circle-fill fs-4 d-block mb-2"></i>
                <strong>¡Reserva realizada con éxito!</strong>
                <br>
                <small>Serás redirigido a tus reservas en unos segundos...</small>
              </div>
            }
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
